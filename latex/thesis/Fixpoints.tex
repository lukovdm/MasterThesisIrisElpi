\documentclass[thesis.tex]{subfiles}

\ifSubfilesClassLoaded{
  \externaldocument{thesis}
  \setcounter{chapter}{2}
}{}

\begin{document}
\chapter{Fixpoints for representation predicates}
\label{ch:fixpoints}
\begin{itemize}
    \item We will show how one can apply the Tarski Fixpoint theorem to create an inductive predicate and how we can create the induction principle from it.
\end{itemize}

\section{Problem statement}
\begin{itemize}
    \item The logic described here is embedded in \coq.
    \item We are only allowed to do structural recursion
    \item The recursive formulation of \isMLL is not structurally recursive
    \item We need another way to define this predicate
    \item Iris already has a way of defining fixpoints that would be applicable
    \item Least fixpoints
    \item Inspired by the Tarski Fixpoint theorem on lattices and ?
    \item
\end{itemize}

\section{Least fixpoint in Iris}
\begin{definition}[Monotone predicate]
    Predicate $\hopred\colon (A \to \iProp) \to  A \to \iProp$ is monotone when for any $\pred, \predB\colon A \to \iProp$, it holds that
    \[\proves \always(\All \var. \pred\var \wand \predB\var) \wand \All \var. \hopred\pred\var \wand \hopred\predB\var\]
\end{definition}
\begin{itemize}
    \item Note that there would have been a similar way we could have written the property of a monotone predicate.
          \[
              \always{(\All \var. \pred\var \wand \predB\var)} * \hopred\pred\var \proves \hopred\predB\var
          \]
    \item This would be more inline with the way they are written in \cref*{ch:backgroundseplogic}
    \item However, these rules are a lot more strict in what the context is in which they are used, thus making them a lot harder to use.
    \item Also, it is the way they are written and used in \iris
    \item We thus write these like in the definition from now on
\end{itemize}

\begin{itemize}
    \item Using this definition of monotone we can define the least fixpoint theorem.
\end{itemize}

\begin{theorem}[Least fixpoint]
    \label{thm:leastfixpoint}
    Given a monotone predicate $\hopred\colon (A \to \iProp) \to  A \to \iProp$, there exists a least fixpoint $\lfp\hopred\colon  A \to \iProp$ such that
    \begin{enumerate}
        \item \[ \lfp\hopred\, \var \provesIff \hopred\, (\lfp\hopred)\, \var \]
        \item \[ \proves \always (\All \varB. \hopred\, \pred\, \varB \wand \pred\, \varB) \wand \All \var. \lfp\hopred\, \var \wand \pred\, \var \]
    \end{enumerate}
\end{theorem}
\begin{proof}
    Given a monotone predicate $\hopred\colon (A \to \iProp) \to  A \to \iProp$ we define $\lfp\hopred$ as
    \[ \lfp\hopred\, \var \eqdef \All \pred. \always(\All \varB. \hopred\, \pred\, \varB \wand \pred\, \varB) \wand \pred \, \var \]
    We now prove the two properties of the least fixpoint
    \begin{enumerate}
        \item We start with proving this right to left, then using the result, prove left to right.
              \begin{description}
                  \item[R-L] We first unfold the definition of $\lfp\hopred\, \var$.
                      \[ \hopred\, \lfp\hopred\, \var \proves \All \pred. \always(\All \varB. \hopred\, \pred\, \varB \wand \pred\, \varB) \wand \pred \, \var \]
                      Next we introduce $\pred$ and the wand.
                      \[ \hopred\, \lfp\hopred\, \var * \always(\All \varB. \hopred\, \pred\, \varB \wand \pred\, \varB) \proves \pred \, \var \]
                      We now apply $\always(\All \varB. \hopred\, \pred\, \varB \wand \pred\, \varB)$ to $\pred\, \var$.
                      \[ \hopred\, \lfp\hopred\, \var * \always(\All \varB. \hopred\, \pred\, \varB \wand \pred\, \varB) \proves \hopred\, \pred\, \var \]
                      We can now use the monotonicity of $\hopred$ with the assumption $\hopred\, \lfp\hopred\, \var$
                      \[ \always(\All \varB. \hopred\, \pred\, \varB \wand \pred\, \varB) \proves \lfp\hopred\, \var \wand \pred\, \var \]
                      After unfolding the definition of $\lfp\, \var$ and introducing the wand we get
                      \[ (\All \pred. \always(\All \varB. \hopred\, \pred\, \varB \wand \pred\, \varB) \wand \pred \, \var) * \always(\All \varB. \hopred\, \pred\, \varB \wand \pred\, \varB) \proves \pred\, \var \]
                      This statement holds by application of the first assumption.
                  \item[L-R] We again first unfold the definition of $\lfp\hopred\, \var$.
                      \[ \All \pred. \always(\All \varB. \hopred\, \pred\, \varB \wand \pred\, \varB) \wand \pred \, \var \proves \hopred\, \lfp\hopred\, \var \]
                      We apply the assumption with $\pred = \hopred\, \lfp\hopred$ resulting in the following statement after introductions
                      \[ \hopred\, (\hopred\, \lfp\hopred)\, \var \proves \hopred\, \lfp\hopred\, \var \]
                      This holds because of monotonicity of $\hopred$ and the above proved property.
              \end{description}
        \item This follows directly from unfolding the definition of $\lfp\hopred$.
    \end{enumerate}
\end{proof}

\begin{itemize}
    \item The second property of the least fixpoint is the normal induction property.
    \item However, it is often useful to make it stronger
\end{itemize}
\begin{lemma}[least fixpoint strong induction principle]
    Given a monotone predicate $\hopred\colon (\sigax \to \iProp) \to (\sigax \to \iProp)$, it holds that
    \[\always(\All\var.\hopred\,(\Lam\varB. \pred\,\varB \land \lfp\hopred\,\varB)\,\var \wand \pred\,\var) \wand \All\var. \lfp\hopred\,\var \wand \pred\,\var\]
\end{lemma}
\begin{itemize}
    \item We now show how this can be applied to create the \isMLL predicate
\end{itemize}
\begin{example}[Iris least fixpoint of \isMLL]
    \label{ex:irisisMLL}
    \begin{itemize}
        \item We want to transform the non-structurally recursive definition of \isMLL into a least fixpoint
    \end{itemize}
    \begin{align*}
        \isMLL\, \hd\, \vect{\val} & = \isMLLRecDef
    \end{align*}
    \begin{itemize}
        \item We start by ?ing any recursive calls in the definition in order to create a functor?
    \end{itemize}
    \begin{align*}
        \isMLL_\hopred\, \pred\, \hd\, \vect{v} & \eqdef
        \isMLLFDef
    \end{align*}
    \begin{itemize}
        \item Predicate $\isMLL_\hopred$ now has type $(\Val \to \vect{\Val} \to \iProp) \to \Val \to \vect{\Val} \to \iProp$
        \item However, the least fixpoint only works for functors of type $(\sigax \to \iProp) \to \sigax \to \iProp$
        \item We solve this by currying $\isMLL_\hopred$ into $\isMLL'_\hopred\colon ((\Val, \vect{\Val}) \to \iProp) \to  (\Val, \vect{\Val}) \to \iProp$
    \end{itemize}
    \begin{align*}
        \isMLL'_\hopred\, \pred\, (\hd, \vect{\val}) \eqdef \isMLL_\hopred\, \pred\, \hd\, \vect{\val}
    \end{align*}
    \begin{itemize}
        \item In order to apply the fixpoint theorem, we need $\isMLL'_\hopred$ to be monotone
    \end{itemize}
    \begin{proof}
        To prove $\isMLL'_\hopred$ is monotone, we need the following to hold.
        \[ \always(\All(\hd, \vect{\val}). \pred\,(\hd, \vect{\val}) \wand \predB\,(\hd, \vect{\val})) \wand \All(\hd, \vect{\val}). \isMLL'_\hopred\, \pred\, (\hd, \vect{\val}) \wand \isMLL'_\hopred\, \predB\, (\hd, \vect{\val}) \]
        We can apply the definition of $\isMLL'_\hopred$, introduce the wands, eliminate the disjunctions on the left and introduce the matching disjunctions on the right in order to get three statements to prove.
        \begin{description}
            \item[Empty MLL:] We need to prove
                \[ \always(\All(\hd, \vect{\val}). \pred\,(\hd, \vect{\val}) \wand \predB\,(\hd, \vect{\val})) * \hd = \None * \vect{\val} = [] \proves \hd = \None * \vect{\val} = [] \]
                This holds trivially
            \item[Marked head:] We first eliminate any existentials on the left and introduce them using the gained variables on the right. We now need to prove
                \begin{align*}
                    \begin{array}{l}
                        \always(\All(\hd, \vect{\val}). \pred\,(\hd, \vect{\val}) \wand \predB\,(\hd, \vect{\val})) * \\
                        \hd = \Some \loc * \loc \fmapsto (\val', \True, \tl) * \pred\, \tl\, \vect{v}
                    \end{array} \proves
                    \hd = \Some \loc * \loc \fmapsto (\val', \True, \tl) * \predB\, \tl\, \vect{v}
                \end{align*}
                The propositions that don't include $\pred$ or $\predB$ cancel each other out, and we are left with the following.
                \begin{align*}
                    \always(\All(\hd, \vect{\val}). \pred\,(\hd, \vect{\val}) \wand \predB\,(\hd, \vect{\val})) * \pred\, \tl\, \vect{v} \proves \predB\, \tl\, \vect{v}
                \end{align*}
                This holds trivially using \ruleref{pers-elim}.
            \item[Unmarked head:] We follow the same prove steps as in the marked head case. \qedhere
        \end{description}
    \end{proof}
    \begin{itemize}
        \item Given that $\isMLL'_\hopred$ is monotone, we now know from \cref*{thm:leastfixpoint} that the least fixpoint exists of $\isMLL'_\hopred$
        \item We can now define $\isMLL'_\hopred$ as
    \end{itemize}
    \begin{align*}
        \isMLL'\, (\hd, \vect{\val}) & \eqdef \lfp(\isMLL'_\hopred)\, (\hd, \vect{\val})                                                          \\
                                     & = \All \pred. \always(\All \varB. \isMLL'_\hopred\, \pred\, \varB \wand \pred\, \varB) \wand \pred \, \var
    \end{align*}
    \begin{itemize}
        \item To finish the definition of \isMLL we uncurry the created fixpoint
    \end{itemize}
    \begin{align*}
        \isMLL\, \hd\, \vect{\val} \eqdef \isMLL'\, (\hd, \vect{\val})
    \end{align*}

\end{example}
\quest{Also highlight the strong induction already or not?}

\section{Changing arities}
\begin{itemize}
    \item We modify the definitions as described in Iris to allow for multiple arity functors.
\end{itemize}
\begin{itemize}
    \item The first step in automating creation of fixpoints is to deal with predicates with more than one argument
    \item In \cref*{ex:irisisMLL} we solved this by currying the predicate before taking the fixpoint
    \item When automating the process we solved this somewhat differently
    \item We change the definitions of and theorems used to match the arity of the predicate we want to take the fixpoint of
\end{itemize}
\begin{definition}[Monotone predicate]
    For any $n\in\nat$, predicate $\hopred\colon (A_1 \to \dots \to A_n \to \iProp) \to A_1 \to \dots \to A_n \to \iProp$ is monotone when for any $\pred, \predB\colon A_1 \to \dots \to A_n \to \iProp$, it holds that
    \begin{align*}
        \proves &
        \begin{array}{rl}
             & \always(\All \var_1,\dots,\var_n. \pred\,\var_1\,\dots\,\var_n \wand \predB\,\var_1\,\dots\,\var_n) \wand   \\
             & \All\var_1,\dots,\var_n. \hopred\,\pred\,\var_1\,\dots\,\var_n \wand \hopred\,\predB\,\var_1\,\dots\,\var_n
        \end{array}
    \end{align*}
\end{definition}
\begin{itemize}
    \item This definition also applies for $n=0$
    \item For example, we can prove the separating conjunction monotone in both its arguments
\end{itemize}
\begin{lemma}[Seperation conjuction is monotone]
    \label{lem:sepmonomar}
    The separation conjunction is monotone in its left and right argument.
\end{lemma}
\begin{proof}
    We only prove monotonicity in its left argument, the proof for the right side is identical.
    We thus need to prove $\pred_\propC\prop = \prop * \propC$ is monotone.
    expanding the definition of monotone for arity one we get the following statement.
    \[\proves \always(\prop \wand \propB) \wand \prop * \propC \wand \propB * \propC\]
    We introduce the wands and persistence modalities giving us the assumptions, $\prop\wand\propB$, $\prop$ and $\propC$.
    We then use \ruleref{sep-mono} using the first two assumptions for proving $\prop$ and using the last assumption for proving $\propC$.
    That $\prop \wand \propB * \prop \proves \propB$ holds follows from \ruleref{wand-IE}, and $\propC \proves \propC$ holds directly.
\end{proof}
\begin{itemize}
    \item In the same way we also modify the least fixpoint theorem
\end{itemize}

\begin{theorem}[Least fixpoint]
    \label{thm:leastfixpointmar}
    Given an $n\in\nat$ and a monotone predicate $\hopred\colon (A_1 \to \dots \to A_n \to \iProp) \to  A_1 \to \dots \to A_n \to \iProp$, there exists a least fixpoint $\lfp\hopred\colon A_1 \to \dots \to A_n \to \iProp$ such that
    \begin{enumerate}
        \item \[ \lfp\hopred\, \var_1\,\dots\,\var_n \provesIff \hopred\, (\lfp\hopred)\, \var_1\,\dots\,\var_n \]
        \item \[
                  \proves \begin{array}{l}
                      \always (\All \varB_1,\dots,\varB_n. \hopred\, \pred\, \varB_1\,\dots\,\varB_n \wand \pred\, \varB_1\,\dots\,\varB_n) \wand \\
                      \All \varB_1,\dots,\varB_n. \lfp\hopred\, \var_1\,\dots\,\var_n \wand \pred\, \var_1\,\dots\,\var_n
                  \end{array}
              \]
    \end{enumerate}
\end{theorem}
\begin{itemize}
    \item The proof follows the same steps as the proof for \cref*{thm:leastfixpoint}
\end{itemize}

\section{Monotone proof search}
\begin{itemize}
    \item We create a system for syntactically finding proofs of monotonicity
    \item Based on generalized rewriting system in coq by \Citeauthor*{sozeauNewLookGeneralized2009} \cite*{sozeauNewLookGeneralized2009}.
    \item \todoo{This is not sufficient but stuck on it} Define monotonicity of connectives in separation logic using proper elements of relations
\end{itemize}

\begin{definition}[Proper element of a relation]
    Given a relation $\rel\colon\sigax\to\sigax\to\Prop$ and an element $\var\in\sigax$, $\var$ is a proper element of $\rel$ if $\rel\, \var\, \var$
\end{definition}
\begin{itemize}
    \item When the relation is reflexive, all possible elements are Proper
    \item For example if we take the magic wand as relation, all propositions are proper.
    \item
\end{itemize}
\begin{definition}[Respectful relation]
    The respectful relation $\rel \respect \rel'\colon(\sigax\to\sigaxB) \to (\sigax\to\sigaxB) \to \Prop$ of two relations $\rel\colon\sigax\to\sigax\to\Prop$, $\rel'\colon\sigaxB\to\sigaxB\to\Prop$ is defined as
    \begin{align*}
        \rel \respect \rel' \eqdef \Lam \func, \funcB. \All \var,\varB. \rel\, \var\, \varB \wand \rel'\, (\func\, \var)\, (\funcB\, \var)
    \end{align*}
\end{definition}

\begin{definition}[Persistent relation]
    The persistent relation $\persrel\rel\colon\sigax\to\sigax\to\Prop$ for a relation $\rel\colon\sigax\to\sigax\to\Prop$ is defined as
    \[\persrel\rel \eqdef \Lam\var,\varB. \always (\rel\,\var\,\varB)\]
\end{definition}

\begin{itemize}
    \item We can rewrite \cref*{lem:sepmonomar} using the relations we described above
\end{itemize}
\begin{lemma}[Separating conjuction monotone]
    The separating conjunction is a proper element of the relation
    $$\persrel{\wandrel} \respect \persrel{\wandrel} \respect {\wandrel}$$
\end{lemma}
\begin{itemize}
    \item Writing out the above statement gives
\end{itemize}
\begin{align*}
    \proves \All \prop,\propB. \always(\prop \wand \propB) \wand \All \prop',\propB'. \always(\prop' \wand \propB') \wand \prop * \propB \wand \prop' * \propB'
\end{align*}
\begin{itemize}
    \item This is monotonicity on the left and right side of the separating conjunction at the same time
\end{itemize}

\begin{definition}[Pointwise relation]
    The pointwise relation $\point \rel$ is a special case of a respectful relation defined as
    \[\point \rel \eqdef (=\ \respect \rel)\]
\end{definition}

\begin{lemma}[Existential quantification monotone]
    The existential quantification is a proper element of the relation \[\persrel(\point\wandrel) \respect {\wandrel}\]
\end{lemma}

\begin{example}[$\isMLL_\hopred$\ is monotone]
    The predicate $\isMLL_\hopred$ is monotone in its first argument. Thus, $\isMLL_\hopred$ is a proper element of
    \[
        \persrel (\point \point \wandrel) \respect \point \point \wandrel
    \]
    \[
        \always{(\All \hd\, \vect{v}. \pred\, \hd\, \vect{v} \wand \predB\, \hd\, \vect{v})} \wand \All \hd\, \vect{v}. \isMLL_\hopred\, \pred\, \hd\, \vect{v} \wand \isMLL_\hopred\, \predB\, \hd\, \vect{v}
    \]
\end{example}
\begin{proof}
    We assume $\always{(\All \hd\, \vect{v}. \pred\, \hd\, \vect{v} \wand \predB\, \hd\, \vect{v})}$ holds and for arbitrary $\hd$ and $\vect{v}$, $\isMLL_\hopred\, \pred\, \hd\, \vect{v}$ holds.
    After applying the definition of $\isMLL_\hopred$ we need to prove \[\isMLL_\hopred\, \predB\, \hd\, \vect{v}\]
\end{proof}

\end{document}
